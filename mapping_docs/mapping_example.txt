Mapping CRR3: 

 

-- ===================================================================== 

-- CRR3 MAPPING: FRWDH -> ABACUS 

-- CCF Ausprägungen: 0%, 10%, 20%, 40%, 50%, 100% 

-- ===================================================================== 

 

WITH source_data AS ( 

    SELECT  

        -- Primärschlüssel und Identifikatoren 

        pos.POSITION_ID, 

        pos.CONTRACT_ID, 

        pos.CUSTOMER_ID, 

        pos.PRODUCT_CODE, 

        pos.BOOK_DATE, 

        pos.MATURITY_DATE, 

        pos.CANCELLATION_NOTICE_PERIOD, 

        pos.CANCELLATION_TYPE, 

         

        -- Quellfelder für B017 (CCF) 

        pos.B500 as RISK_APPROACH,              -- 0=KSA, 2=IRB 

        pos.B603 as RISK_PATH,                  -- 'T'=Transfer, 'O'=Obligor 

        pos.NOMINAL_AMOUNT, 

        pos.OUTSTANDING_AMOUNT, 

        pos.COMMITMENT_TYPE, 

        pos.PRODUCT_CATEGORY, 

        pos.FACILITY_TYPE, 

        pos.REVOCATION_CLAUSE, 

         

        -- Contract-bezogene Felder 

        lgds_abs.XX_CONTRACT as CONTRACT_LGDS_ABS, 

        lgds_full.XX_CONTRACT as CONTRACT_LGDS_FULLSTA, 

         

        -- CCF-relevante Felder 

        solvv.XX_CCF_USED_P as CCF_SOLVV_PERCENT, 

        fullsta.XX_CONV_FACT_STA_P as CCF_FULLSTA_PERCENT, 

         

        -- Neue CRR3-spezifische Felder 

        pos.UNCONDITIONAL_CANCELLATION_FLAG, 

        pos.CONSUMER_PROTECTION_FLAG, 

        pos.CREDIT_DETERIORATION_CLAUSE, 

        pos.SPECIALISED_LENDING_TYPE, 

        pos.PROJECT_FINANCE_FLAG, 

        pos.OBJECT_FINANCE_FLAG, 

        pos.COMMODITY_FINANCE_FLAG, 

         

        -- Erweiterte Bewertungsfelder 

        pos.GUARANTEE_TYPE, 

        pos.COLLATERAL_TYPE, 

        pos.RATING_INTERNAL, 

        pos.RATING_EXTERNAL, 

        pos.INDUSTRY_CODE, 

        pos.COUNTRY_CODE, 

        pos.CURRENCY_CODE, 

        pos.COUNTERPARTY_TYPE, 

        pos.SME_FLAG, 

        pos.LARGE_CORP_FLAG, 

         

        -- CRR3 Double Default Felder 

        pos.DOUBLE_DEFAULT_APPLICABLE, 

        pos.GUARANTOR_RATING, 

        pos.PROTECTION_PROVIDER_TYPE, 

         

        -- Zeitstempel und Verarbeitungsinfo 

        pos.PROCESSING_DATE, 

        pos.DATA_QUALITY_FLAG, 

        pos.VALIDATION_STATUS, 

        pos.CRR3_TRANSITION_DATE 

         

    FROM FRWDH.POSITION pos 

    LEFT JOIN FRWDH.XX_C_CONTRACT_LGDS_CR_ABS lgds_abs  

        ON pos.CONTRACT_ID = lgds_abs.CONTRACT_ID 

    LEFT JOIN FRWDH.XX_C_CONTRACT_LGDS_CR_FULLSTA lgds_full  

        ON pos.CONTRACT_ID = lgds_full.CONTRACT_ID 

    LEFT JOIN FRWDH.XX_C_CONTRACT_LGDS_CR_SOLVV solvv  

        ON pos.CONTRACT_ID = solvv.CONTRACT_ID 

    LEFT JOIN FRWDH.XX_C_CONTRACT_LGDS_CR_FULLSTA fullsta  

        ON pos.CONTRACT_ID = fullsta.CONTRACT_ID 

    WHERE pos.ACTIVE_FLAG = 'Y' 

      AND pos.PROCESSING_DATE = (SELECT MAX(PROCESSING_DATE) FROM FRWDH.POSITION) 

      AND pos.CRR3_APPLICABLE_FLAG = 'Y' 

), 

 

crr3_risk_classification AS ( 

    SELECT *, 

        -- Erweiterte Klassifikation für CRR3 

        CASE  

            WHEN PRODUCT_CODE IN ('CCARD', 'OVERDRAFT') AND COUNTERPARTY_TYPE NOT IN ('BANK', 'LARGE_CORP') THEN 'REVOLVING_RETAIL' 

            WHEN PRODUCT_CODE IN ('CCARD', 'OVERDRAFT') AND COUNTERPARTY_TYPE IN ('BANK', 'LARGE_CORP') THEN 'REVOLVING_CORP' 

            WHEN SPECIALISED_LENDING_TYPE = 'PROJECT' OR PROJECT_FINANCE_FLAG = 'Y' THEN 'PROJECT_FINANCE' 

            WHEN SPECIALISED_LENDING_TYPE = 'OBJECT' OR OBJECT_FINANCE_FLAG = 'Y' THEN 'OBJECT_FINANCE' 

            WHEN SPECIALISED_LENDING_TYPE = 'COMMODITY' OR COMMODITY_FINANCE_FLAG = 'Y' THEN 'COMMODITY_FINANCE' 

            WHEN PRODUCT_CODE IN ('COMMITMENT', 'GUARANTEE') AND COMMITMENT_TYPE = 'UNCONDITIONAL' THEN 'UNCONDITIONAL_COMMITMENT_CRR3' 

            WHEN PRODUCT_CODE IN ('COMMITMENT', 'GUARANTEE') AND COMMITMENT_TYPE = 'CONDITIONAL' THEN 'CONDITIONAL_COMMITMENT' 

            WHEN PRODUCT_CODE IN ('FACILITY', 'CREDIT_LINE') AND UNCONDITIONAL_CANCELLATION_FLAG = 'Y' THEN 'UNCONDITIONAL_CANCELLABLE' 

            WHEN PRODUCT_CODE IN ('FACILITY', 'CREDIT_LINE') AND REVOCATION_CLAUSE = 'CREDIT_DETERIORATION' THEN 'REVOCABLE_CREDIT_LINE' 

            WHEN PRODUCT_CODE IN ('TRADE_FIN', 'LC') THEN 'TRADE_FINANCE' 

            WHEN PRODUCT_CODE IN ('DERIVATIVE', 'SWAP') THEN 'DERIVATIVE_INSTRUMENT' 

            ELSE 'OTHER_EXPOSURE' 

        END as BUSINESS_TYPE_CRR3, 

         

        -- Laufzeitklassifikation für CRR3 

        CASE  

            WHEN MATURITY_DATE IS NULL THEN 'OPEN_ENDED' 

            WHEN MONTHS_BETWEEN(MATURITY_DATE, BOOK_DATE) <= 12 THEN 'SHORT_TERM' 

            WHEN MONTHS_BETWEEN(MATURITY_DATE, BOOK_DATE) <= 36 THEN 'MEDIUM_TERM' 

            ELSE 'LONG_TERM' 

        END as MATURITY_BUCKET, 

         

        -- CRR3 spezifische Kündigungsklassifikation 

        CASE  

            WHEN UNCONDITIONAL_CANCELLATION_FLAG = 'Y' AND CANCELLATION_NOTICE_PERIOD = 0 THEN 'IMMEDIATELY_CANCELLABLE' 

            WHEN UNCONDITIONAL_CANCELLATION_FLAG = 'Y' AND CANCELLATION_NOTICE_PERIOD <= 30 THEN 'SHORT_NOTICE_CANCELLABLE' 

            WHEN REVOCATION_CLAUSE = 'CREDIT_DETERIORATION' THEN 'AUTO_REVOCABLE' 

            WHEN CONSUMER_PROTECTION_FLAG = 'Y' THEN 'CONSUMER_PROTECTED' 

            ELSE 'STANDARD_COMMITMENT' 

        END as CANCELLATION_TYPE_CRR3, 

         

        -- Risikoklassifikation mit CRR3 Anpassungen 

        CASE  

            WHEN RATING_INTERNAL <= 3 THEN 'LOW_RISK' 

            WHEN RATING_INTERNAL <= 6 THEN 'MEDIUM_RISK' 

            WHEN RATING_INTERNAL <= 9 THEN 'HIGH_RISK' 

            ELSE 'DEFAULT_RISK' 

        END as RISK_CATEGORY, 

         

        -- CRR3 Input Floor Klassifikation 

        CASE  

            WHEN COUNTERPARTY_TYPE IN ('BANK', 'SECURITIES_FIRM', 'OTHER_FINANCIAL') THEN 'FINANCIAL_ENTITY' 

            WHEN COUNTERPARTY_TYPE = 'NON_FINANCIAL_CORP' THEN 'NON_FINANCIAL_CORP' 

            WHEN SME_FLAG = 'Y' THEN 'SME' 

            WHEN LARGE_CORP_FLAG = 'Y' THEN 'LARGE_CORP' 

            ELSE 'RETAIL' 

        END as ENTITY_TYPE_CRR3 

    FROM source_data 

), 

 

crr3_ccf_calculation AS ( 

    SELECT *, 

        -- Schritt 1: Prüfung B603 != 'T' and CONTRACT_LGDS_ABS is not NULL 

        CASE  

            WHEN B603 != 'T' AND CONTRACT_LGDS_ABS IS NOT NULL THEN 'STEP_9' 

            ELSE 'STEP_2' 

        END as DECISION_STEP_1, 

         

        -- CRR3 CCF-Berechnung mit erweiterten Werten 

        CASE  

            -- Schritt 9: Spezielle Behandlung mit CRR3 Regeln 

            WHEN B603 != 'T' AND CONTRACT_LGDS_ABS IS NOT NULL THEN 

                CASE  

                    WHEN BUSINESS_TYPE_CRR3 = 'UNCONDITIONAL_CANCELLABLE' THEN 0.1  -- CRR3: 10% statt 0% 

                    WHEN BUSINESS_TYPE_CRR3 = 'REVOCABLE_CREDIT_LINE' THEN 0.1      -- CRR3: 10% mit Übergang zu 40% 

                    WHEN BUSINESS_TYPE_CRR3 = 'REVOLVING_RETAIL' THEN 0.0 

                    WHEN BUSINESS_TYPE_CRR3 = 'REVOLVING_CORP' THEN 0.0            -- Ausnahme für Banken/Großunternehmen 

                    WHEN BUSINESS_TYPE_CRR3 = 'TRADE_FINANCE' THEN 0.2 

                    WHEN BUSINESS_TYPE_CRR3 = 'UNCONDITIONAL_COMMITMENT_CRR3' THEN 0.4  -- CRR3: einheitlich 40% 

                    WHEN BUSINESS_TYPE_CRR3 = 'PROJECT_FINANCE' THEN 0.4 

                    WHEN BUSINESS_TYPE_CRR3 = 'OBJECT_FINANCE' THEN 0.4 

                    WHEN BUSINESS_TYPE_CRR3 = 'COMMODITY_FINANCE' THEN 0.4 

                    WHEN BUSINESS_TYPE_CRR3 = 'CONDITIONAL_COMMITMENT' THEN 0.0 

                    ELSE 1.0 

                END 

             

            -- Schritt 2-4: KSA-Ansatz (B500 = 0) mit CRR3 Anpassungen 

            WHEN RISK_APPROACH = 0 THEN 

                CASE  

                    WHEN CCF_SOLVV_PERCENT IS NULL THEN  

                        -- CRR3 Standardwerte für KSA bei NULL 

                        CASE  

                            WHEN BUSINESS_TYPE_CRR3 = 'UNCONDITIONAL_CANCELLABLE' THEN 0.1 

                            WHEN BUSINESS_TYPE_CRR3 = 'REVOCABLE_CREDIT_LINE' AND CRR3_TRANSITION_DATE >= DATE '2024-01-01' THEN 0.4 

                            WHEN BUSINESS_TYPE_CRR3 = 'REVOCABLE_CREDIT_LINE' THEN 0.1 

                            WHEN BUSINESS_TYPE_CRR3 = 'REVOLVING_RETAIL' THEN 0.0 

                            WHEN BUSINESS_TYPE_CRR3 = 'REVOLVING_CORP' THEN 0.0 

                            WHEN BUSINESS_TYPE_CRR3 = 'TRADE_FINANCE' THEN 0.2 

                            WHEN BUSINESS_TYPE_CRR3 = 'UNCONDITIONAL_COMMITMENT_CRR3' THEN 0.4 

                            WHEN BUSINESS_TYPE_CRR3 IN ('PROJECT_FINANCE', 'OBJECT_FINANCE', 'COMMODITY_FINANCE') THEN 0.4 

                            WHEN BUSINESS_TYPE_CRR3 = 'CONDITIONAL_COMMITMENT' THEN 0.0 

                            ELSE 1.0 

                        END 

                    ELSE  

                        -- Anpassung der SolvV-Werte an CRR3 Standard 

                        CASE  

                            WHEN CCF_SOLVV_PERCENT / 100 < 0.05 THEN 0.0 

                            WHEN CCF_SOLVV_PERCENT / 100 < 0.15 THEN 0.1 

                            WHEN CCF_SOLVV_PERCENT / 100 < 0.30 THEN 0.2 

                            WHEN CCF_SOLVV_PERCENT / 100 < 0.45 THEN 0.4 

                            WHEN CCF_SOLVV_PERCENT / 100 < 0.75 THEN 0.5 

                            ELSE 1.0 

                        END 

                END 

             

            -- Schritt 5-8: IRB-Ansatz (B500 = 2) mit CRR3 Regeln 

            WHEN RISK_APPROACH = 2 THEN 

                CASE  

                    WHEN B603 = 'T' THEN  

                        -- Transferrisiko mit CRR3 Werten 

                        CASE  

                            WHEN BUSINESS_TYPE_CRR3 = 'TRADE_FINANCE' THEN 0.2 

                            WHEN BUSINESS_TYPE_CRR3 = 'UNCONDITIONAL_COMMITMENT_CRR3' THEN 0.4 

                            WHEN BUSINESS_TYPE_CRR3 IN ('PROJECT_FINANCE', 'OBJECT_FINANCE', 'COMMODITY_FINANCE') THEN 0.5 

                            ELSE 1.0 

                        END 

                    WHEN CCF_FULLSTA_PERCENT IS NULL THEN 

                        -- CRR3 IRB Standardwerte bei NULL 

                        CASE  

                            WHEN BUSINESS_TYPE_CRR3 = 'UNCONDITIONAL_CANCELLABLE' THEN 0.1 

                            WHEN BUSINESS_TYPE_CRR3 = 'REVOCABLE_CREDIT_LINE' AND ENTITY_TYPE_CRR3 NOT IN ('FINANCIAL_ENTITY', 'LARGE_CORP') THEN 0.4 

                            WHEN BUSINESS_TYPE_CRR3 = 'REVOCABLE_CREDIT_LINE' THEN 0.1 

                            WHEN BUSINESS_TYPE_CRR3 = 'REVOLVING_RETAIL' THEN 0.0 

                            WHEN BUSINESS_TYPE_CRR3 = 'REVOLVING_CORP' THEN 0.0 

                            WHEN BUSINESS_TYPE_CRR3 = 'TRADE_FINANCE' THEN 0.2 

                            WHEN BUSINESS_TYPE_CRR3 = 'UNCONDITIONAL_COMMITMENT_CRR3' THEN 0.4 

                            WHEN BUSINESS_TYPE_CRR3 IN ('PROJECT_FINANCE', 'OBJECT_FINANCE', 'COMMODITY_FINANCE') THEN 0.4 

                            ELSE 1.0 

                        END 

                    ELSE  

                        -- Anpassung der FullSta-Werte an CRR3 Standard 

                        CASE  

                            WHEN CCF_FULLSTA_PERCENT / 100 < 0.05 THEN 0.0 

                            WHEN CCF_FULLSTA_PERCENT / 100 < 0.15 THEN 0.1 

                            WHEN CCF_FULLSTA_PERCENT / 100 < 0.30 THEN 0.2 

                            WHEN CCF_FULLSTA_PERCENT / 100 < 0.45 THEN 0.4 

                            WHEN CCF_FULLSTA_PERCENT / 100 < 0.75 THEN 0.5 

                            ELSE 1.0 

                        END 

                END 

             

            -- Fallback für andere Risikoansätze 

            ELSE 1.0 

        END as B017_CCF_CALCULATED, 

         

        -- CRR3 spezifische Übergangsregelungen 

        CASE  

            WHEN BUSINESS_TYPE_CRR3 = 'REVOCABLE_CREDIT_LINE' AND CRR3_TRANSITION_DATE < DATE '2024-01-01' THEN 'TRANSITION_PHASE_1' 

            WHEN BUSINESS_TYPE_CRR3 = 'REVOCABLE_CREDIT_LINE' AND CRR3_TRANSITION_DATE >= DATE '2024-01-01' THEN 'TRANSITION_PHASE_2' 

            ELSE 'STANDARD_RULES' 

        END as CRR3_TRANSITION_PHASE 

    FROM crr3_risk_classification 

), 

 

crr3_quality_checks AS ( 

    SELECT *, 

        -- CRR3 Datenqualitätsprüfungen 

        CASE  

            WHEN B017_CCF_CALCULATED NOT IN (0.0, 0.1, 0.2, 0.4, 0.5, 1.0) THEN 'CCF_OUT_OF_RANGE' 

            WHEN RISK_APPROACH NOT IN 

 

 

Mapping CRR2:  

 

-- ===================================================================== 

-- CRR2 MAPPING: FRWDH -> ABACUS 

-- CCF Ausprägungen: 0%, 20%, 50%, 100% 

-- ===================================================================== 

 

WITH source_data AS ( 

    SELECT  

        -- Primärschlüssel und Identifikatoren 

        pos.POSITION_ID, 

        pos.CONTRACT_ID, 

        pos.CUSTOMER_ID, 

        pos.PRODUCT_CODE, 

        pos.BOOK_DATE, 

        pos.MATURITY_DATE, 

         

        -- Quellfelder für B017 (CCF) 

        pos.B500 as RISK_APPROACH,              -- 0=KSA, 2=IRB 

        pos.B603 as RISK_PATH,                  -- 'T'=Transfer, 'O'=Obligor 

        pos.NOMINAL_AMOUNT, 

        pos.OUTSTANDING_AMOUNT, 

        pos.COMMITMENT_TYPE, 

        pos.PRODUCT_CATEGORY, 

         

        -- Contract-bezogene Felder 

        lgds_abs.XX_CONTRACT as CONTRACT_LGDS_ABS, 

        lgds_full.XX_CONTRACT as CONTRACT_LGDS_FULLSTA, 

         

        -- CCF-relevante Felder 

        solvv.XX_CCF_USED_P as CCF_SOLVV_PERCENT, 

        fullsta.XX_CONV_FACT_STA_P as CCF_FULLSTA_PERCENT, 

         

        -- Zusätzliche Bewertungsfelder 

        pos.GUARANTEE_TYPE, 

        pos.COLLATERAL_TYPE, 

        pos.RATING_INTERNAL, 

        pos.RATING_EXTERNAL, 

        pos.INDUSTRY_CODE, 

        pos.COUNTRY_CODE, 

        pos.CURRENCY_CODE, 

         

        -- Zeitstempel und Verarbeitungsinfo 

        pos.PROCESSING_DATE, 

        pos.DATA_QUALITY_FLAG, 

        pos.VALIDATION_STATUS 

         

    FROM FRWDH.POSITION pos 

    LEFT JOIN FRWDH.XX_C_CONTRACT_LGDS_CR_ABS lgds_abs  

        ON pos.CONTRACT_ID = lgds_abs.CONTRACT_ID 

    LEFT JOIN FRWDH.XX_C_CONTRACT_LGDS_CR_FULLSTA lgds_full  

        ON pos.CONTRACT_ID = lgds_full.CONTRACT_ID 

    LEFT JOIN FRWDH.XX_C_CONTRACT_LGDS_CR_SOLVV solvv  

        ON pos.CONTRACT_ID = solvv.CONTRACT_ID 

    LEFT JOIN FRWDH.XX_C_CONTRACT_LGDS_CR_FULLSTA fullsta  

        ON pos.CONTRACT_ID = fullsta.CONTRACT_ID 

    WHERE pos.ACTIVE_FLAG = 'Y' 

      AND pos.PROCESSING_DATE = (SELECT MAX(PROCESSING_DATE) FROM FRWDH.POSITION) 

), 

 

risk_classification AS ( 

    SELECT *, 

        -- Klassifikation der Geschäftsarten für CRR2 

        CASE  

            WHEN PRODUCT_CODE IN ('CCARD', 'OVERDRAFT') THEN 'REVOLVING_CREDIT' 

            WHEN PRODUCT_CODE IN ('COMMITMENT', 'GUARANTEE') AND COMMITMENT_TYPE = 'UNCONDITIONAL' THEN 'UNCONDITIONAL_COMMITMENT' 

            WHEN PRODUCT_CODE IN ('COMMITMENT', 'GUARANTEE') AND COMMITMENT_TYPE = 'CONDITIONAL' THEN 'CONDITIONAL_COMMITMENT' 

            WHEN PRODUCT_CODE IN ('FACILITY', 'CREDIT_LINE') THEN 'CREDIT_FACILITY' 

            WHEN PRODUCT_CODE IN ('TRADE_FIN', 'LC') THEN 'TRADE_FINANCE' 

            WHEN PRODUCT_CODE IN ('DERIVATIVE', 'SWAP') THEN 'DERIVATIVE_INSTRUMENT' 

            ELSE 'OTHER_EXPOSURE' 

        END as BUSINESS_TYPE_CRR2, 

         

        -- Laufzeitklassifikation 

        CASE  

            WHEN MATURITY_DATE IS NULL THEN 'OPEN_ENDED' 

            WHEN MONTHS_BETWEEN(MATURITY_DATE, BOOK_DATE) <= 12 THEN 'SHORT_TERM' 

            WHEN MONTHS_BETWEEN(MATURITY_DATE, BOOK_DATE) <= 36 THEN 'MEDIUM_TERM' 

            ELSE 'LONG_TERM' 

        END as MATURITY_BUCKET, 

         

        -- Risikoklassifikation 

        CASE  

            WHEN RATING_INTERNAL <= 4 THEN 'LOW_RISK' 

            WHEN RATING_INTERNAL <= 7 THEN 'MEDIUM_RISK' 

            WHEN RATING_INTERNAL <= 10 THEN 'HIGH_RISK' 

            ELSE 'DEFAULT_RISK' 

        END as RISK_CATEGORY 

    FROM source_data 

), 

 

ccf_calculation AS ( 

    SELECT *, 

        -- Schritt 1: Prüfung B603 != 'T' and CONTRACT_LGDS_ABS is not NULL 

        CASE  

            WHEN B603 != 'T' AND CONTRACT_LGDS_ABS IS NOT NULL THEN 'STEP_9' 

            ELSE 'STEP_2' 

        END as DECISION_STEP_1, 

         

        -- CCF-Berechnung nach definierten Schritten 

        CASE  

            -- Schritt 9: Spezielle Behandlung 

            WHEN B603 != 'T' AND CONTRACT_LGDS_ABS IS NOT NULL THEN 

                CASE  

                    WHEN BUSINESS_TYPE_CRR2 = 'REVOLVING_CREDIT' THEN 0.0 

                    WHEN BUSINESS_TYPE_CRR2 = 'TRADE_FINANCE' THEN 0.2 

                    WHEN BUSINESS_TYPE_CRR2 = 'UNCONDITIONAL_COMMITMENT' AND MATURITY_BUCKET = 'SHORT_TERM' THEN 0.2 

                    WHEN BUSINESS_TYPE_CRR2 = 'UNCONDITIONAL_COMMITMENT' AND MATURITY_BUCKET != 'SHORT_TERM' THEN 0.5 

                    WHEN BUSINESS_TYPE_CRR2 = 'CONDITIONAL_COMMITMENT' THEN 0.0 

                    WHEN BUSINESS_TYPE_CRR2 = 'CREDIT_FACILITY' THEN 0.0 

                    ELSE 1.0 

                END 

             

            -- Schritt 2-4: KSA-Ansatz (B500 = 0) 

            WHEN RISK_APPROACH = 0 THEN 

                CASE  

                    WHEN CCF_SOLVV_PERCENT IS NULL THEN  

                        -- Standardwerte für KSA bei NULL 

                        CASE  

                            WHEN BUSINESS_TYPE_CRR2 = 'REVOLVING_CREDIT' THEN 0.0 

                            WHEN BUSINESS_TYPE_CRR2 = 'TRADE_FINANCE' THEN 0.2 

                            WHEN BUSINESS_TYPE_CRR2 = 'UNCONDITIONAL_COMMITMENT' AND MATURITY_BUCKET = 'SHORT_TERM' THEN 0.2 

                            WHEN BUSINESS_TYPE_CRR2 = 'UNCONDITIONAL_COMMITMENT' AND MATURITY_BUCKET != 'SHORT_TERM' THEN 0.5 

                            WHEN BUSINESS_TYPE_CRR2 = 'CONDITIONAL_COMMITMENT' THEN 0.0 

                            ELSE 1.0 

                        END 

                    ELSE CCF_SOLVV_PERCENT / 100 

                END 

             

            -- Schritt 5-8: IRB-Ansatz (B500 = 2) 

            WHEN RISK_APPROACH = 2 THEN 

                CASE  

                    WHEN B603 = 'T' THEN  

                        -- Transferrisiko - Standardwerte 

                        CASE  

                            WHEN BUSINESS_TYPE_CRR2 = 'TRADE_FINANCE' THEN 0.2 

                            WHEN BUSINESS_TYPE_CRR2 = 'UNCONDITIONAL_COMMITMENT' THEN 0.5 

                            ELSE 1.0 

                        END 

                    WHEN CCF_FULLSTA_PERCENT IS NULL THEN 

                        -- IRB Standardwerte bei NULL 

                        CASE  

                            WHEN BUSINESS_TYPE_CRR2 = 'REVOLVING_CREDIT' THEN 0.0 

                            WHEN BUSINESS_TYPE_CRR2 = 'TRADE_FINANCE' THEN 0.2 

                            WHEN BUSINESS_TYPE_CRR2 = 'UNCONDITIONAL_COMMITMENT' AND MATURITY_BUCKET = 'SHORT_TERM' THEN 0.2 

                            WHEN BUSINESS_TYPE_CRR2 = 'UNCONDITIONAL_COMMITMENT' AND MATURITY_BUCKET != 'SHORT_TERM' THEN 0.5 

                            ELSE 1.0 

                        END 

                    ELSE CCF_FULLSTA_PERCENT / 100 

                END 

             

            -- Fallback für andere Risikoansätze 

            ELSE 1.0 

        END as B017_CCF_CALCULATED 

    FROM risk_classification 

), 

 

quality_checks AS ( 

    SELECT *, 

        -- Datenqualitätsprüfungen 

        CASE  

            WHEN B017_CCF_CALCULATED NOT IN (0.0, 0.2, 0.5, 1.0) THEN 'CCF_OUT_OF_RANGE' 

            WHEN RISK_APPROACH NOT IN (0, 2) THEN 'INVALID_RISK_APPROACH' 

            WHEN B603 NOT IN ('T', 'O') THEN 'INVALID_RISK_PATH' 

            WHEN NOMINAL_AMOUNT <= 0 THEN 'INVALID_AMOUNT' 

            ELSE 'VALID' 

        END as QUALITY_CHECK_RESULT, 

         

        -- Korrektur für CRR2 zulässige Werte 

        CASE  

            WHEN B017_CCF_CALCULATED < 0.1 THEN 0.0 

            WHEN B017_CCF_CALCULATED < 0.35 THEN 0.2 

            WHEN B017_CCF_CALCULATED < 0.75 THEN 0.5 

            ELSE 1.0 

        END as B017_CCF_FINAL, 

         

        -- Zusätzliche Berechnungen 

        OUTSTANDING_AMOUNT *  

        CASE  

            WHEN B017_CCF_CALCULATED < 0.1 THEN 0.0 

            WHEN B017_CCF_CALCULATED < 0.35 THEN 0.2 

            WHEN B017_CCF_CALCULATED < 0.75 THEN 0.5 

            ELSE 1.0 

        END as RISK_WEIGHTED_EXPOSURE, 

         

        SYSDATE as TRANSFORMATION_DATE, 

        'CRR2_MAPPING_V1.0' as MAPPING_VERSION 

    FROM ccf_calculation 

) 

 

-- Finale Ausgabe für Abacus-Zieldatenbank 

SELECT  

    -- Zielfelder 

    POSITION_ID, 

    CONTRACT_ID, 

    CUSTOMER_ID, 

     

    -- B017: CCF (Credit Conversion Factor) 

    B017_CCF_FINAL as B017, 

     

    -- B603: Risk Path 

    B603, 

     

    -- B500: Risk Approach 

    B500, 

     

    -- Zusätzliche Zielfelder 

    PRODUCT_CODE, 

    BUSINESS_TYPE_CRR2, 

    MATURITY_BUCKET, 

    RISK_CATEGORY, 

    NOMINAL_AMOUNT, 

    OUTSTANDING_AMOUNT, 

    RISK_WEIGHTED_EXPOSURE, 

     

    -- Herkunfts- und Qualitätsinformationen 

    QUALITY_CHECK_RESULT, 

    DECISION_STEP_1, 

    CCF_SOLVV_PERCENT, 

    CCF_FULLSTA_PERCENT, 

     

    -- Metadaten 

    TRANSFORMATION_DATE, 

    MAPPING_VERSION, 

    PROCESSING_DATE as SOURCE_DATE, 

     

    -- Berechnungsdetails zur Nachverfolgung 

    B017_CCF_CALCULATED as CCF_BEFORE_ROUNDING, 

    CASE  

        WHEN QUALITY_CHECK_RESULT != 'VALID' THEN 'MANUAL_REVIEW_REQUIRED' 

        WHEN B017_CCF_FINAL != B017_CCF_CALCULATED THEN 'ROUNDED_TO_STANDARD' 

        ELSE 'AUTO_PROCESSED' 

    END as PROCESSING_STATUS 

 

FROM quality_checks 

WHERE QUALITY_CHECK_RESULT IN ('VALID', 'CCF_OUT_OF_RANGE') 

  AND POSITION_ID IS NOT NULL 

ORDER BY  

    PROCESSING_STATUS DESC, 

    CUSTOMER_ID, 

    CONTRACT_ID, 

    POSITION_ID; 